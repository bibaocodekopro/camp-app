<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Popmart SKU Extractor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-4">

  <!-- Nhập URL -->
  <div class="mb-3">
    <label class="form-label">Nhập URL sản phẩm</label>
    <input type="text" id="productUrl" class="form-control" 
           placeholder="https://www.popmart.com/vn/products/5966/...">
  </div>
  <button id="fetchSku" class="btn btn-primary">Lấy SKU</button>

  <!-- Hiển thị danh sách SKU -->
  <div class="mt-4">
    <label class="form-label">Danh sách SKU</label>
    <select id="skuList" class="form-select"></select>
  </div>

</div>

<script>
async function getSkuList(url) {
  const res = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(url));
  const data = await res.json();
  const html = data.contents;

  // Tìm đoạn JSON trong script
  const match = html.match(/window\.__INITIAL_STATE__\s*=\s*(\{.+?\});/);
  if (!match) return [];

  let json;
  try {
    json = JSON.parse(match[1]);
  } catch (e) {
    console.error("Parse JSON fail", e);
    return [];
  }

  // ✅ Lấy trực tiếp sku list từ JSON
  if (json.productDetail && Array.isArray(json.productDetail.skus)) {
    return json.productDetail.skus.map(s => ({
      id: s.skuId,
      title: s.title
    }));
  }

  return [];
}

$("#fetchSku").click(async () => {
  const url = $("#productUrl").val().trim();
  if (!url) return alert("Nhập URL đi bạn ơi");

  $("#skuList").empty().append(`<option>Đang tải...</option>`);

  const list = await getSkuList(url);

  $("#skuList").empty();
  if (list.length === 0) {
    $("#skuList").append(`<option>Không tìm thấy skuId</option>`);
  } else {
    list.forEach(s => {
      $("#skuList").append(`<option value="${s.id}">${s.title} (skuId: ${s.id})</option>`);
    });
  }
});
</script>
</body>
</html>
